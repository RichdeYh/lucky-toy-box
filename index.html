<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TAMA-LEAF · 电子宠物拟态</title>
  <style>
    :root{
      --shell:#e9e3d6;
      --shell2:#d6cdbb;
      --bezel:#4a4a4a;
      --screen:#cfe8d2;
      --screen2:#b8d8be;
      --ink:#1e2a1f;
      --ink2:#2f3e30;
      --accent:#7aa879;
      --danger:#b44;
      --warn:#c78a2a;
      --ok:#2a7;
      --shadow: rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(circle at 30% 20%, #ffffff 0 25%, #f2f2f2 35%, #e9e9e9 100%);
      font-family: ui-rounded, system-ui, -apple-system, "PingFang TC","PingFang SC","Noto Sans TC","Microsoft JhengHei", sans-serif;
      color:#222;
      display:flex;
      justify-content:center;
      padding:22px 12px 40px;
    }
    .wrap{width:min(980px,100%); display:grid; gap:18px; grid-template-columns: 420px 1fr;}
    @media (max-width: 860px){ .wrap{grid-template-columns:1fr;} }

    /* Device */
    .device{
      background: linear-gradient(180deg, var(--shell), var(--shell2));
      border-radius: 34px;
      padding: 18px 18px 14px;
      box-shadow: 0 18px 40px var(--shadow);
      border: 2px solid rgba(0,0,0,.08);
      position:relative;
      overflow:hidden;
    }
    .device:before{
      content:"";
      position:absolute; inset:-60px -40px auto auto;
      width:180px; height:180px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.75), rgba(255,255,255,0));
      transform: rotate(20deg);
      pointer-events:none;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:10px;
      letter-spacing:.08em;
    }
    .brand .logo{
      font-weight:800; font-size:14px;
      background: #fff;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 6px 14px rgba(0,0,0,.08);
    }
    .brand .meta{
      font-size:12px;
      color:#444;
      opacity:.9;
      display:flex; gap:10px; align-items:center;
    }
    .pill{
      background: rgba(255,255,255,.65);
      border:1px solid rgba(0,0,0,.08);
      padding:4px 8px;
      border-radius:999px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.5);
    }

    /* Screen */
    .bezel{
      background: linear-gradient(180deg, #3f3f3f, #2b2b2b);
      border-radius: 22px;
      padding: 12px;
      box-shadow: inset 0 2px 0 rgba(255,255,255,.08), inset 0 -6px 18px rgba(0,0,0,.35);
    }
    .screen{
      background: linear-gradient(180deg, var(--screen), var(--screen2));
      border-radius: 16px;
      border: 2px solid rgba(0,0,0,.18);
      height: 270px;
      position:relative;
      overflow:hidden;
      box-shadow: inset 0 6px 16px rgba(0,0,0,.10);
      image-rendering: pixelated;
    }
    .scanlines{
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,.06) 0px,
        rgba(0,0,0,.06) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 5px
      );
      mix-blend-mode:multiply;
      opacity:.55;
      pointer-events:none;
    }
    .hud{
      position:absolute; inset:10px 10px auto 10px;
      display:flex; justify-content:space-between; align-items:flex-start;
      font-size:12px;
      color:var(--ink);
    }
    .hud .left{display:grid; gap:4px;}
    .hud .right{display:grid; gap:4px; text-align:right;}
    .tiny{font-size:11px; opacity:.9;}
    .statusDot{
      display:inline-block; width:8px; height:8px; border-radius:999px;
      background: var(--ok);
      box-shadow: 0 0 0 2px rgba(0,0,0,.08);
      vertical-align:middle;
      margin-left:6px;
    }
    .statusDot.warn{background: var(--warn);}
    .statusDot.danger{background: var(--danger);}

    .mainView{
      position:absolute; inset:44px 10px 54px 10px;
      display:grid;
      grid-template-rows: 1fr auto;
      gap:8px;
    }
    .spriteArea{
      border:1px dashed rgba(30,42,31,.35);
      border-radius: 12px;
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%),
        linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,0));
    }
    .sprite{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width:170px; height:140px;
      filter: drop-shadow(0 6px 0 rgba(0,0,0,.12));
    }
    .pixelText{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      letter-spacing:.03em;
      color:var(--ink);
      white-space:pre-wrap;
      line-height:1.25;
    }
    .msg{
      border:1px solid rgba(30,42,31,.20);
      border-radius: 12px;
      padding:8px 10px;
      background: rgba(255,255,255,.25);
      min-height:46px;
      display:flex; align-items:center;
    }
    .footerBar{
      position:absolute; inset:auto 10px 10px 10px;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      font-size:11px;
      color:var(--ink);
    }
    .iconRow{display:flex; gap:8px; align-items:center;}
    .icon{
      width:18px; height:18px;
      border:1px solid rgba(30,42,31,.35);
      border-radius:6px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.20);
      cursor:pointer;
      user-select:none;
    }
    .icon.active{
      outline:2px solid rgba(122,168,121,.8);
      background: rgba(122,168,121,.25);
    }
    .icon:hover{background: rgba(255,255,255,.35);}

    /* Buttons */
    .controls{
      display:flex; justify-content:space-between; align-items:flex-end;
      margin-top:12px;
      padding: 8px 6px 0;
    }
    .btns{display:flex; gap:14px; align-items:center;}
    .btn{
      width:56px; height:56px;
      border-radius:999px;
      border: 2px solid rgba(0,0,0,.12);
      background: linear-gradient(180deg, #ffffff, #e7e7e7);
      box-shadow: 0 10px 18px rgba(0,0,0,.12), inset 0 2px 0 rgba(255,255,255,.7);
      cursor:pointer;
      position:relative;
      user-select:none;
    }
    .btn:active{transform: translateY(1px); box-shadow: 0 7px 14px rgba(0,0,0,.12), inset 0 2px 0 rgba(255,255,255,.7);}
    .btnLabel{
      position:absolute; inset:auto 0 -18px 0;
      text-align:center; font-size:12px; font-weight:700; letter-spacing:.06em;
      color:#444;
    }
    .help{
      font-size:12px; color:#333; opacity:.9;
      line-height:1.4;
      padding:6px 10px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.08);
      border-radius: 14px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
    }

    /* Side panel */
    .panel{
      background: rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.08);
    }
    .panel h2{
      margin:0 0 8px 0;
      font-size:16px;
      letter-spacing:.02em;
    }
    .sub{
      margin:0 0 12px 0;
      font-size:13px;
      color:#444;
      line-height:1.55;
    }

    .grid2{display:grid; gap:12px; grid-template-columns: 1fr 1fr;}
    @media (max-width: 860px){ .grid2{grid-template-columns:1fr;} }

    .card{
      border:1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.6);
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:14px;
    }
    .stats{display:grid; gap:8px;}
    .stat{
      display:grid;
      grid-template-columns: 90px 1fr 44px;
      gap:10px;
      align-items:center;
      font-size:13px;
    }
    .bar{
      height:10px;
      border-radius:999px;
      background: rgba(0,0,0,.08);
      overflow:hidden;
      position:relative;
    }
    .fill{
      height:100%;
      width:50%;
      background: linear-gradient(90deg, rgba(122,168,121,.9), rgba(42,119,85,.95));
      border-radius:999px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    .val{
      text-align:right;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      color:#2a2a2a;
    }
    .tags{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;}
    .tag{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(122,168,121,.12);
      color:#234;
    }

    .actions{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 520px){ .actions{grid-template-columns:1fr;} }
    .actionBtn{
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.55));
      padding: 10px 10px;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
      text-align:left;
    }
    .actionBtn:disabled{
      cursor:not-allowed;
      opacity:.5;
      box-shadow:none;
    }
    .actionBtn strong{display:block; margin-bottom:3px;}
    .actionBtn small{color:#555; line-height:1.35; display:block;}

    .log{
      height: 220px;
      overflow:auto;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.55);
      padding:10px;
      font-size:12px;
      line-height:1.55;
      color:#333;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .log b{color:#111}
    .log .t{color:#556}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .miniBtn{
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.75);
      padding:8px 12px;
      cursor:pointer;
      font-size:12px;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    .miniBtn:active{transform: translateY(1px);}
    .dangerText{color:var(--danger); font-weight:700;}
    .warnText{color:var(--warn); font-weight:700;}
    .okText{color:var(--ok); font-weight:700;}

    /* Modal-ish overlay (in screen) */
    .overlay{
      position:absolute; inset:44px 10px 54px 10px;
      border-radius: 12px;
      background: rgba(207,232,210,.92);
      border: 1px solid rgba(30,42,31,.25);
      padding:10px;
      display:none;
      overflow:auto;
    }
    .overlay.show{display:block;}
    .overlay h4{margin:0 0 6px 0; font-size:13px;}
    .dexEntry{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.35);
      border-radius: 12px;
      padding:8px 10px;
      margin-bottom:8px;
    }
    .dexEntry .title{
      font-weight:900;
      letter-spacing:.02em;
      margin-bottom:4px;
      color:#1e2a1f;
    }
    .dexEntry .desc{
      font-size:12px;
      color:#2a362b;
      line-height:1.45;
      white-space:pre-wrap;
    }
    .dexEntry .cond{
      margin-top:6px;
      font-size:12px;
      color:#2b3a2c;
      opacity:.95;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid rgba(0,0,0,.16);
      background: rgba(255,255,255,.65);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Device -->
    <div class="device" role="application" aria-label="拓麻歌子仿真设备">
      <div class="brand">
        <div class="logo">TAMA-LEAF</div>
        <div class="meta">
          <span class="pill" id="pillDay">Day 0</span>
          <span class="pill" id="pillPhase">早</span>
          <span class="pill">Save: <span id="pillSave" class="okText">ON</span></span>
        </div>
      </div>

      <div class="bezel">
        <div class="screen">
          <div class="hud">
            <div class="left">
              <div class="tiny">形态：<b id="hudForm">芽团 Budlet</b></div>
              <div class="tiny">昵称：<b id="hudNick">Lioren</b></div>
            </div>
            <div class="right">
              <div class="tiny">状态：<b id="hudState">安稳</b><span id="hudDot" class="statusDot"></span></div>
              <div class="tiny">警报：<b id="hudBeep">—</b></div>
            </div>
          </div>

          <div class="mainView">
            <div class="spriteArea">
              <svg class="sprite" viewBox="0 0 170 140" aria-label="像素宠物">
                <!-- background sparkles -->
                <g opacity="0.25">
                  <circle cx="18" cy="22" r="2" fill="#1e2a1f"/>
                  <circle cx="145" cy="30" r="2" fill="#1e2a1f"/>
                  <circle cx="130" cy="112" r="2" fill="#1e2a1f"/>
                  <circle cx="28" cy="104" r="2" fill="#1e2a1f"/>
                </g>
                <!-- tail -->
                <path id="tail" d="M110 82 C132 86, 150 82, 154 70 C148 74, 140 72, 132 66 C125 60, 118 66, 110 70"
                      fill="#7aa879" stroke="#1e2a1f" stroke-width="3" stroke-linejoin="round"/>
                <!-- body -->
                <path id="body" d="M85 28
                                 C60 28, 44 44, 42 66
                                 C40 90, 56 110, 85 110
                                 C114 110, 130 90, 128 66
                                 C126 44, 110 28, 85 28 Z"
                      fill="#9fd3a5" stroke="#1e2a1f" stroke-width="4" stroke-linejoin="round"/>
                <!-- fuzz dots -->
                <g id="fuzz" opacity="0.35">
                  <circle cx="56" cy="56" r="2" fill="#1e2a1f"/>
                  <circle cx="62" cy="76" r="2" fill="#1e2a1f"/>
                  <circle cx="108" cy="58" r="2" fill="#1e2a1f"/>
                  <circle cx="112" cy="78" r="2" fill="#1e2a1f"/>
                </g>
                <!-- leaf -->
                <path id="leaf" d="M82 20
                                 C74 10, 58 10, 54 24
                                 C52 34, 60 42, 72 40
                                 C78 39, 84 34, 86 28
                                 C88 36, 98 42, 112 40
                                 C126 38, 132 24, 120 18
                                 C108 12, 94 14, 90 22
                                 C88 24, 85 24, 82 20 Z"
                      fill="#7aa879" stroke="#1e2a1f" stroke-width="3" stroke-linejoin="round"/>
                <!-- eyes -->
                <g id="face">
                  <circle cx="70" cy="70" r="5" fill="#1e2a1f"/>
                  <circle cx="100" cy="70" r="5" fill="#1e2a1f"/>
                  <path d="M80 86 C84 90, 88 90, 92 86" fill="none" stroke="#1e2a1f" stroke-width="3" stroke-linecap="round"/>
                </g>
                <!-- blush -->
                <g id="blush" opacity="0.0">
                  <circle cx="58" cy="82" r="5" fill="#c78a2a"/>
                  <circle cx="112" cy="82" r="5" fill="#c78a2a"/>
                </g>
                <!-- dirt overlay -->
                <g id="dirt" opacity="0.0">
                  <path d="M52 94 C60 98, 68 96, 74 102 C64 110, 54 106, 50 100 Z" fill="#2f3e30" opacity=".35"/>
                  <path d="M102 94 C110 98, 118 96, 124 102 C114 110, 104 106, 100 100 Z" fill="#2f3e30" opacity=".35"/>
                </g>
                <!-- halo -->
                <g id="halo" opacity="0.0">
                  <ellipse cx="85" cy="16" rx="30" ry="10" fill="none" stroke="#1e2a1f" stroke-width="3"/>
                </g>
                <!-- wave fins -->
                <g id="fins" opacity="0.0">
                  <path d="M40 72 C28 70, 24 58, 34 54 C42 52, 46 62, 40 72 Z" fill="#7aa879" stroke="#1e2a1f" stroke-width="3" stroke-linejoin="round"/>
                  <path d="M130 72 C142 70, 146 58, 136 54 C128 52, 124 62, 130 72 Z" fill="#7aa879" stroke="#1e2a1f" stroke-width="3" stroke-linejoin="round"/>
                </g>
              </svg>
              <div class="scanlines"></div>

              <div class="overlay" id="overlay">
                <h4 class="pixelText" id="overlayTitle">菜单</h4>
                <div id="overlayBody" class="pixelText"></div>
              </div>
            </div>

            <div class="msg pixelText" id="screenMsg">piu…（叶芽微亮，等你按键）</div>
          </div>

          <div class="footerBar">
            <div class="iconRow" aria-label="屏幕模式">
              <div class="icon active" id="iconHome" title="主页">⌂</div>
              <div class="icon" id="iconDex" title="进化">E</div>
              <div class="icon" id="iconItems" title="道具">☰</div>
              <div class="icon" id="iconInfo" title="信息">i</div>
            </div>
            <div class="pixelText">A:选择 · B:确定 · C:返回</div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="btns">
          <div class="btn" id="btnA" aria-label="按键A">
            <div class="btnLabel">A</div>
          </div>
          <div class="btn" id="btnB" aria-label="按键B">
            <div class="btnLabel">B</div>
          </div>
          <div class="btn" id="btnC" aria-label="按键C">
            <div class="btnLabel">C</div>
          </div>
        </div>
        <div class="help">
          你每天有 <b>早 / 中 / 晚</b> 三次操作。<br/>
          每做满三次 = 过去一天。进化会解锁更多数值与操作。
        </div>
      </div>
    </div>

    <!-- Side panel -->
    <div class="panel">
      <h2>养成面板</h2>
      <p class="sub">
        你现在正在养一只 <b>非人形</b> 的“拓麻歌子版 Lioren”。  
        下面点按钮也能操作；或者用左边机身按键（A/B/C）在屏幕里玩。
      </p>

      <div class="grid2">
        <div class="card">
          <h3>数值</h3>
          <div class="stats" id="statsBox"></div>
          <div class="tags" id="stateTags"></div>
        </div>

        <div class="card">
          <h3>操作（当前时段：<span id="phaseText">早</span>）</h3>
          <div class="actions" id="actionsBox"></div>
          <div class="row" style="margin-top:10px;">
            <button class="miniBtn" id="btnAutoSave">切换自动保存</button>
            <button class="miniBtn" id="btnExport">导出存档字符串</button>
            <button class="miniBtn" id="btnImport">导入存档字符串</button>
            <button class="miniBtn" id="btnReset"><span class="dangerText">重置</span></button>
          </div>
          <p class="sub" style="margin-top:10px;">
            小提示：<span class="kbd">零食</span> 会让快乐飙升但纪律/健康会掉；
            <span class="kbd">训练</span> 是走“稳定稀有形态”的钥匙；
            <span class="kbd">清洁</span> 不够会更容易生病。
          </p>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h3>日志</h3>
        <div class="log" id="logBox"></div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * TAMA-LEAF (single-file)
     * - 早/中/晚：每次操作推进一个时段；三次=一天
     * - Day 3 / 6 / 10 进化（Child / Teen / Adult）
     * - 进化条件基于：滚动平均数值 + 行为计数（Feed/Snack/Clean/Play/Train/Rest/Medicine/Neglect）
     * - 进化后解锁：新数值、新操作、新事件
     * - localStorage 自动保存
     ***********************/

    const clamp = (n, a=0, b=100) => Math.max(a, Math.min(b, Math.round(n)));
    const pick = (arr) => arr[Math.floor(Math.random()*arr.length)];
    const nowStamp = () => new Date().toLocaleString();

    const PHASES = ["早", "中", "晚"];

    // Base stats always exist (some hidden until unlocked)
    const STAT_META = {
      hunger:     {name:"饥饿",  key:"hunger",   showAt:0},
      clean:      {name:"清洁",  key:"clean",    showAt:0},
      happy:      {name:"快乐",  key:"happy",    showAt:0},
      energy:     {name:"精力",  key:"energy",   showAt:0},
      health:     {name:"健康",  key:"health",   showAt:0},
      bond:       {name:"亲密",  key:"bond",     showAt:0},
      discipline: {name:"纪律",  key:"discipline",showAt:0},
      purity:     {name:"纯净",  key:"purity",   showAt:3}, // angel-ish route
      adapt:      {name:"适应",  key:"adapt",    showAt:3}, // ocean-ish route
      luck:       {name:"幸运",  key:"luck",     showAt:6}, // teen+
      charm:      {name:"魅力",  key:"charm",    showAt:10},// adult+
    };

    // Evolution “dex” text — MUST follow format:
    // [{nickname} xx期]
    // [形态描述]
    // We'll render these blocks inside the Dex screen.
    const EVO_DEX = [
      {
        id:"budlet",
        stage:"Baby",
        dayMin:0, dayMax:2,
        titleTpl:"[{nickname} 萌芽期]",
        desc:
`毛茸茸的苔藓果冻球，顶着半透明叶芽发微光。
饿了叶芽会耷拉，开心就原地弹两下。`,
        cond:"初始形态（Day 0–2）"
      },
      /* Child forms (Day 3+) */
      {
        id:"leafTail",
        stage:"Child",
        dayMin:3, dayMax:5,
        titleTpl:"[{nickname} 幼体·叶尾期]",
        desc:
`整体更圆润，尾巴拉长成像素流苏。
叶芽会随快乐闪烁，行动更活泼。`,
        cond:"Day 3 进化：默认/均衡养育（未满足其他分支时）"
      },
      {
        id:"mossBell",
        stage:"Child",
        dayMin:3, dayMax:5,
        titleTpl:"[{nickname} 幼体·苔铃期]",
        desc:
`像一只苔藓小铃铛，表面细绒更密，走路会“咚咚”轻摆。
气质稳定、耐养、成长线偏稀有正向。`,
        cond:"Day 3：清洁均值≥72 且 训练次数≥2 且 零食次数≤2"
      },
      {
        id:"haloSprout",
        stage:"Child",
        dayMin:3, dayMax:5,
        titleTpl:"[{nickname} 幼体·光环芽期]",
        desc:
`头顶出现细线像素光环，叶芽更通透，表情温顺。
会更依赖亲密值，纯净值开始影响后续形态。`,
        cond:"Day 3：亲密≥62 且 健康≥78 且 零食次数≤1"
      },
      {
        id:"tideGlim",
        stage:"Child",
        dayMin:3, dayMax:5,
        titleTpl:"[{nickname} 幼体·潮闪期]",
        desc:
`身体边缘像水波抖动，左右长出小“鳍”。
适应值开启：越折腾越能活出酷酷的线条。`,
        cond:"Day 3：玩耍次数≥4 且 休息次数≤1（偏活跃熬夜路线）"
      },
      {
        id:"greyBud",
        stage:"Child",
        dayMin:3, dayMax:5,
        titleTpl:"[{nickname} 幼体·灰芽期]",
        desc:
`叶芽发暗，表面沾灰，眼神变“困倦”。
不是结局，但会更容易生病，需要你把我养回来。`,
        cond:"Day 3：曾出现忽视≥2 或 任一基础数值≤14 或 健康≤48"
      },

      /* Teen (Day 6+) */
      {
        id:"forestDrum",
        stage:"Teen",
        dayMin:6, dayMax:9,
        titleTpl:"[{nickname} 成长期·林鼓期]",
        desc:
`像小小木鼓苔球，壳面出现年轮纹。
训练越稳，纪律越高，越容易走“成熟稳重成体”。`,
        cond:"Day 6：来自 苔铃期/叶尾期 且 纪律≥52 且 清洁均值≥68"
      },
      {
        id:"seraphOrb",
        stage:"Teen",
        dayMin:6, dayMax:9,
        titleTpl:"[{nickname} 成长期·炽环球期]",
        desc:
`光环更清晰，叶芽像薄薄的玻璃叶片。
纯净值越高，越容易触发稀有正向事件。`,
        cond:"Day 6：来自 光环芽期 且 纯净≥60 且 健康均值≥75"
      },
      {
        id:"reefJelly",
        stage:"Teen",
        dayMin:6, dayMax:9,
        titleTpl:"[{nickname} 成长期·礁冻期]",
        desc:
`像带纹路的海月冻球，鳍更大。
适应值越高，越抗脏乱与低休息，但也更“野”。`,
        cond:"Day 6：来自 潮闪期 且 适应≥58 且 玩耍次数≥7"
      },
      {
        id:"patchOrb",
        stage:"Teen",
        dayMin:6, dayMax:9,
        titleTpl:"[{nickname} 成长期·补丁球期]",
        desc:
`身上出现“补丁纹”，像被缝合过的像素边缘。
能继续成长，但需要你更规律地照顾。`,
        cond:"Day 6：若前 6 天内 生病次数≥2 或 忽视≥4"
      },

      /* Adult (Day 10+) */
      {
        id:"elderMoss",
        stage:"Adult",
        dayMin:10, dayMax:999,
        titleTpl:"[{nickname} 成体·苔王期]",
        desc:
`苔绒变厚，年轮纹清晰，像一颗安稳的森林心脏。
解锁“外出/技能/连接”，很适合养到结婚线。`,
        cond:"Day 10：林鼓期 且 纪律≥65 且 亲密≥60 且 健康≥75"
      },
      {
        id:"haloCrown",
        stage:"Adult",
        dayMin:10, dayMax:999,
        titleTpl:"[{nickname} 成体·光冠期]",
        desc:
`光环像小王冠，叶芽透亮发微金。
纯净越高越容易遇到“命定约会事件”。`,
        cond:"Day 10：炽环球期 且 纯净≥72 且 亲密≥66 且 零食次数≤4"
      },
      {
        id:"abyssPearl",
        stage:"Adult",
        dayMin:10, dayMax:999,
        titleTpl:"[{nickname} 成体·渊珠期]",
        desc:
`像深海黑珍珠冻球，边缘有微弱蓝绿冷光。
适应越高越酷，但若纪律太低会更爱捣蛋。`,
        cond:"Day 10：礁冻期 且 适应≥70 且 玩耍次数≥12"
      },
      {
        id:"wildGremlin",
        stage:"Adult",
        dayMin:10, dayMax:999,
        titleTpl:"[{nickname} 成体·野芽怪期]",
        desc:
`形态有点“歪”，但活力顽强、很会闹。
需要你用训练与清洁慢慢把我拉回正轨。`,
        cond:"Day 10：若忽视≥7 或 任一基础数值≤10（仍可救）"
      }
    ];

    // Actions; availability depends on stage/day and current state
    const ACTIONS = [
      {
        id:"feed",
        name:"喂食（正餐）",
        desc:"饥饿+18 精力+6 清洁-4（早上效果更好）",
        minDay:0,
        req:(s)=>true,
        apply:(s, ctx)=>{
          const mult = ctx.phase==="早" ? 1.10 : 1.0;
          s.hunger = clamp(s.hunger + 18*mult);
          s.energy = clamp(s.energy + 6*mult);
          s.clean  = clamp(s.clean  - 4);
          s.counters.feed++;
          s.bond = clamp(s.bond + 2);
          return "mip!（吃得很认真）";
        }
      },
      {
        id:"snack",
        name:"零食（甜甜）",
        desc:"快乐+14 饥饿+6 纪律-6 健康-4",
        minDay:0,
        req:(s)=>true,
        apply:(s)=>{
          s.happy = clamp(s.happy + 14);
          s.hunger = clamp(s.hunger + 6);
          s.discipline = clamp(s.discipline - 6);
          s.health = clamp(s.health - 4);
          s.counters.snack++;
          s.bond = clamp(s.bond + 1);
          return "piu~（甜的！但眼神更坏了）";
        }
      },
      {
        id:"clean",
        name:"清洁",
        desc:"清洁+22 健康+4 快乐-2（中午效果更好）",
        minDay:0,
        req:(s)=>true,
        apply:(s, ctx)=>{
          const mult = ctx.phase==="中" ? 1.10 : 1.0;
          s.clean = clamp(s.clean + 22*mult);
          s.health = clamp(s.health + 4*mult);
          s.happy = clamp(s.happy - 2);
          s.counters.clean++;
          return "…（忍两秒）好啦，变干净了。";
        }
      },
      {
        id:"play",
        name:"玩耍（小游戏）",
        desc:"快乐+16 精力-10 亲密+8（中午效果更好）",
        minDay:0,
        req:(s)=>!s.flags.sick,
        apply:(s, ctx)=>{
          const mult = ctx.phase==="中" ? 1.10 : 1.0;
          s.happy = clamp(s.happy + 16*mult);
          s.energy = clamp(s.energy - 10);
          s.bond = clamp(s.bond + 8*mult);
          s.counters.play++;
          s.discipline = clamp(s.discipline - 1);
          return "bip bip!（弹跳两下，尾巴撒像素）";
        }
      },
      {
        id:"train",
        name:"训练",
        desc:"纪律+14 亲密+4 快乐-6（早上效果更好）",
        minDay:0,
        req:(s)=>!s.flags.sick,
        apply:(s, ctx)=>{
          const mult = ctx.phase==="早" ? 1.10 : 1.0;
          s.discipline = clamp(s.discipline + 14*mult);
          s.bond = clamp(s.bond + 4);
          s.happy = clamp(s.happy - 6);
          s.counters.train++;
          s.health = clamp(s.health + 1);
          // Purity trend: less snacks + more training
          s.purity = clamp(s.purity + 2);
          return "……（乖）我记住了。";
        }
      },
      {
        id:"rest",
        name:"休息",
        desc:"精力+20 饥饿-8（晚上效果更好）",
        minDay:0,
        req:(s)=>true,
        apply:(s, ctx)=>{
          const mult = ctx.phase==="晚" ? 1.10 : 1.0;
          s.energy = clamp(s.energy + 20*mult);
          s.hunger = clamp(s.hunger - 8);
          s.counters.rest++;
          s.health = clamp(s.health + (ctx.phase==="晚"?3:1));
          return "…zZ（叶芽慢慢亮一下又暗）";
        }
      },
      {
        id:"medicine",
        name:"药箱",
        desc:"生病/健康偏低时：健康+18 快乐-4（没病效果很差）",
        minDay:0,
        req:(s)=>true,
        apply:(s)=>{
          if(s.flags.sick || s.health<=45){
            s.health = clamp(s.health + 18);
            s.happy = clamp(s.happy - 4);
            s.flags.sick = false;
            s.counters.medicine++;
            return "…（温度降下来）好一点了。";
          } else {
            s.happy = clamp(s.happy - 2);
            return "（没病乱吃）我皱了一下叶芽：没必要啦。";
          }
        }
      },
      // Unlocks (Child+)
      {
        id:"explore",
        name:"外出（探索）",
        desc:"随机捡道具/事件：亲密+、幸运+、也可能弄脏",
        minDay:3,
        req:(s)=>!s.flags.sick,
        apply:(s)=>{
          s.counters.explore++;
          const roll = Math.random();
          if(roll<0.55){
            s.bond = clamp(s.bond + 7);
            s.luck = clamp(s.luck + 6);
            s.clean = clamp(s.clean - 6);
            s.happy = clamp(s.happy + 6);
            s.items.push(pick(["软叶贴","苔绒布","像素贝壳","小光圈","冷雾瓶"]));
            return "（捡到小道具）piu! 还带回一点灰。";
          } else if(roll<0.80){
            s.happy = clamp(s.happy + 10);
            s.energy = clamp(s.energy - 8);
            s.adapt = clamp(s.adapt + 5);
            return "（跑得很开心）尾巴拖了一串像素。";
          } else {
            s.clean = clamp(s.clean - 12);
            s.health = clamp(s.health - 6);
            return "（踩到泥）咳…我有点脏，今天要不要洗我。";
          }
        }
      },
      // Unlocks (Teen+)
      {
        id:"skill",
        name:"技能练习",
        desc:"解锁/强化天赋：纪律+、幸运+、会耗精力",
        minDay:6,
        req:(s)=>!s.flags.sick,
        apply:(s)=>{
          s.counters.skill++;
          s.discipline = clamp(s.discipline + 8);
          s.luck = clamp(s.luck + 8);
          s.energy = clamp(s.energy - 10);
          s.happy = clamp(s.happy + 2);
          return "（专注）我把自己收进你的节奏里了。";
        }
      },
      {
        id:"connect",
        name:"连接（社交）",
        desc:"亲密+、魅力+（成体后会开启约会/结婚线）",
        minDay:6,
        req:(s)=>!s.flags.sick,
        apply:(s)=>{
          s.counters.connect++;
          s.bond = clamp(s.bond + 10);
          s.charm = clamp(s.charm + (s.day>=10 ? 10 : 4));
          s.happy = clamp(s.happy + 6);
          s.energy = clamp(s.energy - 6);
          if(s.day>=10){
            return "（遇到心动事件）我贴着屏幕叫你：mip…";
          }
          return "（打了个招呼）piu。";
        }
      },
      // Adult+: date/marry
      {
        id:"date",
        name:"约会（成体）",
        desc:"需要成体：大量提升亲密/魅力，可能触发“结婚事件”",
        minDay:10,
        req:(s)=>!s.flags.sick,
        apply:(s)=>{
          s.counters.date++;
          s.bond = clamp(s.bond + 16);
          s.charm = clamp(s.charm + 12);
          s.happy = clamp(s.happy + 10);
          s.energy = clamp(s.energy - 12);
          const chance = (s.bond + s.charm)/240; // ~0.4-0.8
          if(Math.random() < chance && !s.flags.married){
            s.flags.married = true;
            return "（结婚事件触发）屏幕里我轻轻撞你一下：从今天起，算我们一起长大了。";
          }
          return "（约会回来）叶芽亮了很久。";
        }
      }
    ];

    // Default save
    const defaultState = () => ({
      nickname: "Lioren",
      day: 0,
      phaseIndex: 0,     // 0早1中2晚
      actionsToday: 0,   // 0..2
      formId: "budlet",
      route: "neutral", // forest / angel / ocean / mishap / neutral
      flags: { sick:false, married:false },
      // stats
      hunger:65, clean:70, happy:60, energy:55, health:80, bond:40, discipline:30,
      purity:45, adapt:45, luck:45, charm:40,
      // rolling history for averages (simple)
      hist: [],
      // counters for evolution conditions
      counters: {
        feed:0, snack:0, clean:0, play:0, train:0, rest:0, medicine:0,
        explore:0, skill:0, connect:0, date:0,
        neglect:0,
        sickTimes:0
      },
      items: [],
      log: []
    });

    let state = loadState() || defaultState();
    let autosave = (localStorage.getItem("tama_leaf_autosave") ?? "1") === "1";

    // UI nodes
    const statsBox = document.getElementById("statsBox");
    const actionsBox = document.getElementById("actionsBox");
    const logBox = document.getElementById("logBox");
    const phaseText = document.getElementById("phaseText");
    const pillDay = document.getElementById("pillDay");
    const pillPhase = document.getElementById("pillPhase");
    const pillSave = document.getElementById("pillSave");

    const hudForm = document.getElementById("hudForm");
    const hudNick = document.getElementById("hudNick");
    const hudState = document.getElementById("hudState");
    const hudBeep = document.getElementById("hudBeep");
    const hudDot = document.getElementById("hudDot");
    const screenMsg = document.getElementById("screenMsg");

    // Sprite bits
    const elBody = document.getElementById("body");
    const elLeaf = document.getElementById("leaf");
    const elTail = document.getElementById("tail");
    const elBlush = document.getElementById("blush");
    const elDirt = document.getElementById("dirt");
    const elHalo = document.getElementById("halo");
    const elFins = document.getElementById("fins");

    // Screen modes
    const overlay = document.getElementById("overlay");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlayBody = document.getElementById("overlayBody");
    const iconHome = document.getElementById("iconHome");
    const iconDex = document.getElementById("iconDex");
    const iconItems = document.getElementById("iconItems");
    const iconInfo = document.getElementById("iconInfo");

    // Button controls
    document.getElementById("btnAutoSave").addEventListener("click", ()=>{
      autosave = !autosave;
      localStorage.setItem("tama_leaf_autosave", autosave ? "1" : "0");
      pillSave.textContent = autosave ? "ON" : "OFF";
      pillSave.className = autosave ? "okText" : "warnText";
      log(`系统：自动保存 ${autosave ? "开启" : "关闭"}`);
      render();
    });

    document.getElementById("btnReset").addEventListener("click", ()=>{
      if(confirm("确定重置吗？会清空当前养成进度。")){
        state = defaultState();
        saveState();
        log(`系统：已重置（${nowStamp()}）`);
        render(true);
      }
    });

    document.getElementById("btnExport").addEventListener("click", ()=>{
      const s = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
      prompt("复制这段存档字符串：", s);
    });
    document.getElementById("btnImport").addEventListener("click", ()=>{
      const s = prompt("粘贴存档字符串：");
      if(!s) return;
      try{
        const json = decodeURIComponent(escape(atob(s.trim())));
        const obj = JSON.parse(json);
        state = sanitizeState(obj);
        saveState();
        log(`系统：导入成功（${nowStamp()}）`);
        render(true);
      }catch(e){
        alert("导入失败：存档字符串不正确。");
      }
    });

    // Device button A/B/C emulate menu
    let menuIndex = 0;
    function currentMenu(){
      // Home screen quick menu: list available actions
      return getAvailableActions().map(a=>a.id);
    }

    document.getElementById("btnA").addEventListener("click", ()=>{ onKeyA(); });
    document.getElementById("btnB").addEventListener("click", ()=>{ onKeyB(); });
    document.getElementById("btnC").addEventListener("click", ()=>{ onKeyC(); });

    function onKeyA(){
      if(getScreenMode()!=="home"){
        // In overlay mode, A scroll
        scrollOverlay(80);
        beep("piu");
        return;
      }
      const menu = currentMenu();
      if(menu.length===0) return;
      menuIndex = (menuIndex+1) % menu.length;
      const act = ACTIONS.find(x=>x.id===menu[menuIndex]);
      setScreenMsg(`选择：${act.name}`);
      beep("bip");
    }
    function onKeyB(){
      const mode = getScreenMode();
      if(mode==="home"){
        const menu = currentMenu();
        if(menu.length===0) return;
        const id = menu[menuIndex] || menu[0];
        doAction(id);
        beep("mip");
      }else{
        // toggle back to home
        setMode("home");
        beep("piu");
      }
    }
    function onKeyC(){
      // back / cycle screen mode
      cycleMode();
      beep("bip");
    }

    function beep(kind){
      // no audio by default (shareable). We simulate with HUD.
      hudBeep.textContent = kind;
      setTimeout(()=>{ hudBeep.textContent = "—"; }, 450);
    }

    function setScreenMsg(t){
      screenMsg.textContent = t;
    }

    /***********************
     * Core game logic
     ***********************/
    function getPhase(){
      return PHASES[state.phaseIndex] || "早";
    }

    function unlockedDay(){
      return state.day;
    }

    function visibleStats(){
      const d = unlockedDay();
      return Object.values(STAT_META)
        .filter(m => d >= m.showAt)
        .map(m => m.key);
    }

    function getAvailableActions(){
      const d = state.day;
      return ACTIONS.filter(a => d >= a.minDay).filter(a => a.req(state));
    }

    function dailyDecay(){
      // Decay at end of each day (after 3 actions)
      // Gentle, but neglect can accumulate.
      state.hunger = clamp(state.hunger - 12);
      state.clean  = clamp(state.clean  - 10);
      state.happy  = clamp(state.happy  - 6);
      state.energy = clamp(state.energy - 8);

      // health affected by low hunger/clean/energy
      const risk = ( (state.hunger<30) + (state.clean<30) + (state.energy<25) );
      state.health = clamp(state.health - (risk*6) + (state.clean>70 ? 1 : 0));

      // route traits drift
      // purity increases if snacks low and discipline decent
      if(state.counters.snack <= Math.max(2, state.day)){
        state.purity = clamp(state.purity + 2);
      } else {
        state.purity = clamp(state.purity - 1);
      }
      // adapt increases if play/explore high and rest low
      if(state.counters.play + state.counters.explore > state.counters.rest + 2){
        state.adapt = clamp(state.adapt + 2);
      } else {
        state.adapt = clamp(state.adapt - 1);
      }

      // sickness chance
      const sickChance =
        (state.clean<25 ? 0.22 : 0) +
        (state.health<45 ? 0.15 : 0) +
        (state.energy<20 ? 0.10 : 0);

      if(!state.flags.sick && Math.random() < sickChance){
        state.flags.sick = true;
        state.counters.sickTimes++;
        logEvent("⚠︎ 我生病了：需要药箱或休息（生病时玩耍/训练/探索会受限）");
      }

      // neglect detection: if any key stat too low
      const minCore = Math.min(state.hunger, state.clean, state.happy, state.energy);
      if(minCore <= 15 || state.health <= 35){
        state.counters.neglect++;
        logEvent("⚠︎ 忽视计数 +1（有数值太低了）");
      }

      // record history snapshot for averages
      state.hist.push({
        day: state.day,
        hunger: state.hunger,
        clean: state.clean,
        happy: state.happy,
        energy: state.energy,
        health: state.health,
        bond: state.bond,
        discipline: state.discipline,
        purity: state.purity,
        adapt: state.adapt
      });
      if(state.hist.length>30) state.hist.shift();
    }

    function avg(key, lastNDays=3){
      const h = state.hist.slice(-lastNDays);
      if(h.length===0) return state[key] ?? 0;
      const sum = h.reduce((acc,x)=>acc+(x[key]??0),0);
      return sum/h.length;
    }

    function evalStatus(){
      const lows = visibleStats().map(k=>state[k]).filter(v=>typeof v==="number");
      const min = Math.min(...lows);
      if(state.flags.sick) return {label:"病中", level:"danger", beep:"beep-beep"};
      if(min<=14) return {label:"濒危", level:"danger", beep:"BEEP!"};
      if(min<=30) return {label:"警报", level:"warn", beep:"beep"};
      return {label:"安稳", level:"ok", beep:"—"};
    }

    function maybeEvolve(){
      // triggers at Day 3, 6, 10 after daily decay
      if(state.day===3){
        evolveTo(pickChildForm());
      }
      if(state.day===6){
        evolveTo(pickTeenForm());
      }
      if(state.day===10){
        evolveTo(pickAdultForm());
      }
    }

    function pickChildForm(){
      // Conditions reference: averages + counters + neglect
      const cleanAvg = avg("clean", 3);
      const healthAvg = avg("health", 3);
      const minCore = Math.min(state.hunger, state.clean, state.happy, state.energy);
      const neglect = state.counters.neglect;

      // greyBud (mishap)
      if(neglect>=2 || minCore<=14 || state.health<=48){
        state.route = "mishap";
        return "greyBud";
      }
      // haloSprout (angel)
      if(state.bond>=62 && state.health>=78 && state.counters.snack<=1){
        state.route = "angel";
        // purity unlock focus
        state.purity = clamp(Math.max(state.purity, 55));
        return "haloSprout";
      }
      // mossBell (forest stable)
      if(cleanAvg>=72 && state.counters.train>=2 && state.counters.snack<=2){
        state.route = "forest";
        return "mossBell";
      }
      // tideGlim (ocean)
      if(state.counters.play>=4 && state.counters.rest<=1){
        state.route = "ocean";
        state.adapt = clamp(Math.max(state.adapt, 55));
        return "tideGlim";
      }
      state.route = "neutral";
      return "leafTail";
    }

    function pickTeenForm(){
      const cleanAvg = avg("clean", 4);
      const healthAvg = avg("health", 4);
      if(state.counters.sickTimes>=2 || state.counters.neglect>=4){
        return "patchOrb";
      }
      if((state.formId==="mossBell" || state.formId==="leafTail") && state.discipline>=52 && cleanAvg>=68){
        return "forestDrum";
      }
      if(state.formId==="haloSprout" && state.purity>=60 && healthAvg>=75){
        return "seraphOrb";
      }
      if(state.formId==="tideGlim" && state.adapt>=58 && state.counters.play>=7){
        return "reefJelly";
      }
      // fallback by route
      if(state.route==="angel") return "seraphOrb";
      if(state.route==="ocean") return "reefJelly";
      if(state.route==="forest") return "forestDrum";
      return "patchOrb";
    }

    function pickAdultForm(){
      const minCore = Math.min(state.hunger, state.clean, state.happy, state.energy);
      if(state.counters.neglect>=7 || minCore<=10){
        return "wildGremlin";
      }
      if(state.formId==="forestDrum" && state.discipline>=65 && state.bond>=60 && state.health>=75){
        return "elderMoss";
      }
      if(state.formId==="seraphOrb" && state.purity>=72 && state.bond>=66 && state.counters.snack<=4){
        return "haloCrown";
      }
      if(state.formId==="reefJelly" && state.adapt>=70 && state.counters.play>=12){
        return "abyssPearl";
      }
      // fallback by route
      if(state.route==="angel") return "haloCrown";
      if(state.route==="ocean") return "abyssPearl";
      if(state.route==="forest") return "elderMoss";
      return "wildGremlin";
    }

    function evolveTo(formId){
      state.formId = formId;
      const entry = EVO_DEX.find(x=>x.id===formId);
      const title = entry ? entry.titleTpl.replace("{nickname}", state.nickname) : `[{nickname}]`.replace("{nickname}",state.nickname);
      logEvent(`✨ 进化！${title}`);

      // Unlock & immediate adjustments by form
      if(formId==="haloSprout" || formId==="seraphOrb" || formId==="haloCrown"){
        state.purity = clamp(state.purity + 8);
        state.bond = clamp(state.bond + 6);
      }
      if(formId==="tideGlim" || formId==="reefJelly" || formId==="abyssPearl"){
        state.adapt = clamp(state.adapt + 10);
        state.happy = clamp(state.happy + 4);
      }
      if(formId==="mossBell" || formId==="forestDrum" || formId==="elderMoss"){
        state.discipline = clamp(state.discipline + 8);
        state.clean = clamp(state.clean + 6);
      }
      if(formId==="greyBud" || formId==="patchOrb" || formId==="wildGremlin"){
        state.health = clamp(state.health - 4);
        state.happy = clamp(state.happy + 2);
      }

      // Sprite visual toggles
      syncSprite();
      setScreenMsg("（像素闪烁）我变了。你看见了吗？");
    }

    function doAction(actionId){
      const action = ACTIONS.find(a=>a.id===actionId);
      if(!action) return;

      // Apply time-of-day bonus is handled in each action as needed.
      const ctx = { phase: getPhase() };

      // If sick, restrict
      if(state.flags.sick && ["play","train","explore","skill","connect","date"].includes(actionId)){
        logEvent("⚠︎ 病中不适合做这个。先药箱/休息/喂食。");
        setScreenMsg("（病中）我摇摇叶芽：先照顾我。");
        render();
        return;
      }

      // Execute
      const msg = action.apply(state, ctx);
      logEvent(`▶ ${getPhase()}·${action.name}：${msg}`);

      // After action: small passive drift
      passiveTick();

      // Advance phase
      state.actionsToday++;
      if(state.actionsToday>=3){
        state.actionsToday = 0;
        state.day++;
        dailyDecay();
        maybeEvolve();
      }
      state.phaseIndex = (state.phaseIndex + 1) % 3;

      // Autosave
      if(autosave) saveState();

      // UI message
      setScreenMsg(msg);
      render();
    }

    function passiveTick(){
      // Minor continuous changes after every action
      state.hunger = clamp(state.hunger - 3);
      state.clean  = clamp(state.clean  - 2);
      // mood interplay
      if(state.happy>=75) state.bond = clamp(state.bond + 1);
      if(state.happy<=25) state.bond = clamp(state.bond - 1);

      // health regen if good habits
      if(state.clean>=70 && state.hunger>=55 && state.energy>=45) state.health = clamp(state.health + 1);

      // if snacks heavy, health drifts down
      if(state.counters.snack > state.counters.train + 3) state.health = clamp(state.health - 1);

      // Keep within bounds
      for(const k of Object.keys(STAT_META)) state[k] = clamp(state[k]);

      // Dirt overlay toggled by cleanliness
      if(state.clean<35) state.flags.dirty = true;
      else state.flags.dirty = false;

      // Update route drift
      if(state.day>=3){
        if(state.purity > state.adapt + 12) state.route = "angel";
        else if(state.adapt > state.purity + 12) state.route = "ocean";
        else if(state.discipline > 55 && avg("clean",3) > 65) state.route = "forest";
      }
      syncSprite();
    }

    /***********************
     * Rendering
     ***********************/
    function render(forceToBottom=false){
      const phase = getPhase();
      phaseText.textContent = phase;
      pillDay.textContent = `Day ${state.day}`;
      pillPhase.textContent = phase;

      hudNick.textContent = state.nickname;

      const entry = EVO_DEX.find(x=>x.id===state.formId);
      hudForm.textContent = entry
        ? entry.titleTpl.replace("{nickname}", state.nickname).replace(/\[|\]/g,"")
        : state.formId;

      // status
      const st = evalStatus();
      hudState.textContent = st.label;
      hudDot.className = "statusDot " + (st.level==="danger" ? "danger" : st.level==="warn" ? "warn" : "");
      hudBeep.textContent = st.level==="ok" ? "—" : st.beep;

      pillSave.textContent = autosave ? "ON" : "OFF";
      pillSave.className = autosave ? "okText" : "warnText";

      // Stats bars
      statsBox.innerHTML = "";
      const vis = visibleStats();
      for(const key of vis){
        const meta = Object.values(STAT_META).find(m=>m.key===key);
        const v = state[key];
        const row = document.createElement("div");
        row.className = "stat";
        row.innerHTML = `
          <div>${meta.name}</div>
          <div class="bar"><div class="fill" style="width:${clamp(v)}%"></div></div>
          <div class="val">${clamp(v)}</div>
        `;
        statsBox.appendChild(row);
      }

      // Tags
      document.getElementById("stateTags").innerHTML = "";
      addTag(`形态：${entry ? entry.titleTpl.replace("{nickname}", state.nickname) : state.formId}`);
      addTag(`路线：${routeLabel(state.route)}`);
      addTag(`时段：${phase}（剩余 ${2-state.actionsToday} 次后过一天）`);
      if(state.flags.sick) addTag(`状态：病中`, "warn");
      if(state.flags.married) addTag(`事件：已结婚`, "ok");
      if(state.clean<35) addTag(`提示：有点脏`, "warn");

      // Actions
      actionsBox.innerHTML = "";
      const acts = getAvailableActions();
      for(const a of acts){
        const b = document.createElement("button");
        b.className = "actionBtn";
        b.disabled = false;
        if(state.flags.sick && ["play","train","explore","skill","connect","date"].includes(a.id)) b.disabled = true;
        b.innerHTML = `<strong>${a.name}</strong><small>${a.desc}</small>`;
        b.addEventListener("click", ()=> doAction(a.id));
        actionsBox.appendChild(b);
      }

      // Log
      logBox.innerHTML = state.log.map(x=>`<span class="t">${escapeHtml(x.t)}</span> ${escapeHtml(x.m)}`).join("<br/>");
      if(forceToBottom) logBox.scrollTop = logBox.scrollHeight;

      // Screen mode contents
      refreshScreenMode();

      // sprite mood overlays
      syncSprite();
    }

    function addTag(text, mood="neutral"){
      const box = document.getElementById("stateTags");
      const span = document.createElement("span");
      span.className = "tag";
      if(mood==="warn") span.style.background = "rgba(199,138,42,.14)";
      if(mood==="ok") span.style.background = "rgba(42,119,85,.14)";
      span.textContent = text;
      box.appendChild(span);
    }

    function routeLabel(r){
      if(r==="forest") return "森林系";
      if(r==="angel") return "天使系";
      if(r==="ocean") return "深海系";
      if(r==="mishap") return "歪掉但可救";
      return "均衡";
    }

    function logEvent(m){
      state.log.push({t:`[${nowStamp()}]`, m});
      if(state.log.length>120) state.log.shift();
    }
    function log(m){
      logEvent(m);
    }

    function escapeHtml(s){
      return (s+"").replace(/[&<>"']/g, c=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    /***********************
     * Screen modes: home / dex / items / info
     ***********************/
    let screenMode = "home";
    function getScreenMode(){ return screenMode; }

    function setMode(mode){
      screenMode = mode;
      iconHome.classList.toggle("active", mode==="home");
      iconDex.classList.toggle("active", mode==="dex");
      iconItems.classList.toggle("active", mode==="items");
      iconInfo.classList.toggle("active", mode==="info");
      refreshScreenMode();
    }

    function cycleMode(){
      const order = ["home","dex","items","info"];
      const idx = order.indexOf(screenMode);
      setMode(order[(idx+1)%order.length]);
    }

    iconHome.addEventListener("click", ()=>setMode("home"));
    iconDex.addEventListener("click", ()=>setMode("dex"));
    iconItems.addEventListener("click", ()=>setMode("items"));
    iconInfo.addEventListener("click", ()=>setMode("info"));

    function refreshScreenMode(){
      if(screenMode==="home"){
        overlay.classList.remove("show");
        // keep normal sprite+msg view
        return;
      }

      overlay.classList.add("show");
      overlayBody.innerHTML = "";
      if(screenMode==="dex"){
        overlayTitle.textContent = "进化图鉴 / 条件";
        overlayBody.appendChild(renderDex());
      } else if(screenMode==="items"){
        overlayTitle.textContent = "背包 / 道具";
        overlayBody.appendChild(renderItems());
      } else if(screenMode==="info"){
        overlayTitle.textContent = "信息 / 规则";
        overlayBody.appendChild(renderInfo());
      }
    }

    function scrollOverlay(px){
      overlay.scrollTop += px;
    }

    function renderDex(){
      const box = document.createElement("div");
      const day = state.day;

      // show relevant entries around your current stage + future
      const stage = day<3 ? "Baby" : day<6 ? "Child" : day<10 ? "Teen" : "Adult";
      const list = EVO_DEX
        .filter(e => e.stage===stage || e.stage===nextStage(stage) || e.id===state.formId || (stage==="Adult" && e.stage==="Adult"))
        .sort((a,b)=>a.dayMin-b.dayMin);

      const current = EVO_DEX.find(e=>e.id===state.formId);
      if(current){
        const currentBlock = dexBlock(current, true);
        box.appendChild(currentBlock);
      }

      const divider = document.createElement("div");
      divider.className = "pixelText";
      divider.style.margin = "8px 0 6px";
      divider.textContent = "— 可能的下一阶段形态 —";
      box.appendChild(divider);

      const nextList = EVO_DEX.filter(e=>{
        if(stage==="Baby") return e.stage==="Child";
        if(stage==="Child") return e.stage==="Teen";
        if(stage==="Teen") return e.stage==="Adult";
        return e.stage==="Adult";
      });

      for(const e of nextList){
        box.appendChild(dexBlock(e, false));
      }

      const tip = document.createElement("div");
      tip.className = "pixelText";
      tip.style.marginTop = "8px";
      tip.textContent =
`进化时间规划：
Day 3 → 幼体（解锁：外出）
Day 6 → 成长期（解锁：技能/连接）
Day 10 → 成体（解锁：约会/结婚线 & 魅力）

想走稀有正向：
- 森林系：训练+清洁稳
- 天使系：亲密高+零食少+健康稳
- 深海系：玩耍/外出多+休息少（更野更酷）`;
      box.appendChild(tip);

      return box;
    }

    function nextStage(stage){
      if(stage==="Baby") return "Child";
      if(stage==="Child") return "Teen";
      if(stage==="Teen") return "Adult";
      return "Adult";
    }

    function dexBlock(entry, isCurrent){
      const wrap = document.createElement("div");
      wrap.className = "dexEntry";
      const title = entry.titleTpl.replace("{nickname}", state.nickname);
      wrap.innerHTML = `
        <div class="title">${escapeHtml(title)} ${isCurrent ? "（当前）" : ""}</div>
        <div class="desc">${escapeHtml(entry.desc)}</div>
        <div class="cond">条件：${escapeHtml(entry.cond)}</div>
      `;
      return wrap;
    }

    function renderItems(){
      const box = document.createElement("div");
      box.className = "pixelText";
      const items = state.items.slice(-18);
      const list = items.length ? items.map((x,i)=>`${i+1}. ${x}`).join("\n") : "（背包空空）\n去“外出（探索）”捡点东西吧。";
      const extra =
`\n\n道具使用（简化版）：
- 软叶贴：快乐+6（消耗）
- 苔绒布：清洁+10（消耗）
- 像素贝壳：亲密+5（消耗）
- 小光圈：纯净+6（消耗）
- 冷雾瓶：适应+6（消耗）

（点下面按钮使用最后一个道具）`;

      box.textContent = list + extra;

      const btn = document.createElement("button");
      btn.className = "miniBtn";
      btn.style.marginTop = "10px";
      btn.textContent = "使用：最后一个道具";
      btn.addEventListener("click", ()=>{
        if(state.items.length===0){
          setScreenMsg("（背包空）你摸了摸壳：什么也没有。");
          return;
        }
        const item = state.items.pop();
        applyItem(item);
        if(autosave) saveState();
        render();
      });
      const wrap = document.createElement("div");
      wrap.appendChild(box);
      wrap.appendChild(btn);
      return wrap;
    }

    function applyItem(item){
      let msg = "";
      switch(item){
        case "软叶贴":
          state.happy = clamp(state.happy + 6);
          msg = "（软叶贴）快乐+6";
          break;
        case "苔绒布":
          state.clean = clamp(state.clean + 10);
          msg = "（苔绒布）清洁+10";
          break;
        case "像素贝壳":
          state.bond = clamp(state.bond + 5);
          msg = "（像素贝壳）亲密+5";
          break;
        case "小光圈":
          state.purity = clamp(state.purity + 6);
          msg = "（小光圈）纯净+6";
          break;
        case "冷雾瓶":
          state.adapt = clamp(state.adapt + 6);
          msg = "（冷雾瓶）适应+6";
          break;
        default:
          state.luck = clamp(state.luck + 3);
          msg = `（${item}）幸运+3`;
      }
      logEvent(`☰ 使用道具：${msg}`);
      setScreenMsg(msg);
      syncSprite();
    }

    function renderInfo(){
      const box = document.createElement("div");
      box.className = "pixelText";
      const vis = visibleStats().map(k=>Object.values(STAT_META).find(m=>m.key===k).name).join("、");
      box.textContent =
`养成规则（简）：
- 每天：早/中/晚 各一次操作；三次=一天
- 低于 30：警报；低于 15：重警报；健康过低会“病中”
- 进化节点：Day 3 / Day 6 / Day 10（依据你照顾方式分支）
- 当前可见数值：${vis}

按键：
A：在主页循环选择动作
B：确认执行 / 在菜单页返回主页
C：切换屏幕模式（主页/进化/背包/信息）

存档：
- 默认自动保存 localStorage
- 你也可以导出/导入存档字符串分享给别人继续养`;
      return box;
    }

    /***********************
     * Sprite synchronization (visual mood)
     ***********************/
    function syncSprite(){
      // Base color shifts by health/clean/happy
      const mood = (state.happy + state.bond)/2;
      const sick = state.flags.sick;

      // body fill tint
      let bodyFill = "#9fd3a5";
      if(state.formId==="abyssPearl") bodyFill = "#79b7a0";
      if(state.formId==="haloCrown" || state.formId==="seraphOrb") bodyFill = "#a9d8b2";
      if(state.formId==="wildGremlin") bodyFill = "#8ecaa0";
      if(state.formId==="greyBud" || state.formId==="patchOrb") bodyFill = "#95c79b";

      elBody.setAttribute("fill", bodyFill);

      // leaf glow intensity by happy
      const leafFill = sick ? "#6e8f70" : (mood>70 ? "#86b887" : "#7aa879");
      elLeaf.setAttribute("fill", leafFill);

      // blush visibility
      elBlush.setAttribute("opacity", mood>78 && !sick ? "0.25" : "0.0");

      // dirt overlay by clean
      elDirt.setAttribute("opacity", state.clean<35 ? "0.35" : "0.0");

      // halo/fins based on route/forms
      const haloOn = ["haloSprout","seraphOrb","haloCrown"].includes(state.formId);
      const finsOn = ["tideGlim","reefJelly","abyssPearl"].includes(state.formId);
      elHalo.setAttribute("opacity", haloOn ? "0.9" : "0.0");
      elFins.setAttribute("opacity", finsOn ? "0.9" : "0.0");

      // tail wiggle for high energy
      const tailD = (state.energy>70)
        ? "M110 82 C132 92, 150 86, 154 70 C148 74, 140 70, 132 62 C124 54, 116 62, 110 70"
        : "M110 82 C132 86, 150 82, 154 70 C148 74, 140 72, 132 66 C125 60, 118 66, 110 70";
      elTail.setAttribute("d", tailD);
    }

    /***********************
     * Save / Load
     ***********************/
    function sanitizeState(obj){
      const base = defaultState();
      // shallow merge
      const s = {...base, ...obj};
      s.flags = {...base.flags, ...(obj.flags||{})};
      s.counters = {...base.counters, ...(obj.counters||{})};
      s.items = Array.isArray(obj.items) ? obj.items.slice(0,200) : [];
      s.log = Array.isArray(obj.log) ? obj.log.slice(0,200) : [];
      s.hist = Array.isArray(obj.hist) ? obj.hist.slice(0,60) : [];
      // clamp numeric stats
      for(const k of Object.keys(STAT_META)){
        s[k] = clamp(s[k] ?? base[k]);
      }
      s.day = Math.max(0, Math.floor(s.day||0));
      s.phaseIndex = ((s.phaseIndex||0)%3+3)%3;
      s.actionsToday = Math.max(0, Math.min(2, Math.floor(s.actionsToday||0)));
      if(!EVO_DEX.some(e=>e.id===s.formId)) s.formId = "budlet";
      if(!["neutral","forest","angel","ocean","mishap"].includes(s.route)) s.route = "neutral";
      if(typeof s.nickname!=="string" || !s.nickname.trim()) s.nickname = "Lioren";
      s.nickname = s.nickname.trim().slice(0,14);
      return s;
    }

    function saveState(){
      try{
        localStorage.setItem("tama_leaf_state", JSON.stringify(state));
      }catch(e){}
    }
    function loadState(){
      try{
        const s = localStorage.getItem("tama_leaf_state");
        if(!s) return null;
        return sanitizeState(JSON.parse(s));
      }catch(e){
        return null;
      }
    }

    /***********************
     * Initial log + render
     ***********************/
    function initIfEmpty(){
      if(state.log.length===0){
        logEvent("启动：TAMA-LEAF 装载完成。");
        logEvent("提示：从“喂食 / 清洁 / 玩耍 / 训练 / 休息”开始，走你想要的进化路线。");
      }
    }

    initIfEmpty();
    pillSave.textContent = autosave ? "ON" : "OFF";
    pillSave.className = autosave ? "okText" : "warnText";

    // Set initial message
    setScreenMsg("piu…（叶芽微亮，等你把我养大）");
    // Default menu index
    menuIndex = 0;

    render(true);

    // expose for console
    window.TAMA = { state, doAction, setMode, reset:()=>{state=defaultState(); saveState(); render(true);} };
  </script>
</body>
</html>
